<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>live627:join_reason</id>
	<version>1.3</version>

	<file name="$sourcedir/Register.php">
		<operation>
			<search position="before"><![CDATA[// You can't register if it's disabled.
	if (!empty($modSettings['registration_method']) && $modSettings['registration_method'] == 3)
		fatal_lang_error('registration_disabled', false);]]></search>
			<add><![CDATA[
	
	// You can't register without a reason..
	 if (empty($_POST['join_reason']) || trim($_POST['join_reason']) == '')
		fatal_lang_error('error_join_reason_empty', false);]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[ 'secret_answer',]]></search>
			<add><![CDATA[ 'join_reason',]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA['theme_vars' => array(),]]></search>
			<add><![CDATA[
		'join_reason' => $_POST['join_reason'],]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/Subs-Members.php">
		<operation>
			<search position="before"><![CDATA['smiley_set' => '',]]></search>
			<add><![CDATA[
		'join_reason' => (!empty($regOptions['join_reason']) ? $regOptions['join_reason'] : ''),]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[mem.last_login,]]></search>
			<add><![CDATA[ mem.join_reason,]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/ManageMembers.php">
		<operation>
			<search position="replace"><![CDATA['date_registered' => array('label' => $txt['admin_browse_registered']),
	);]]></search>
			<add><![CDATA['date_registered' => array('label' => $txt['admin_browse_registered']),
		'join_reason' => array('label' => $txt['admin_browse_join_reason']),
	);]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA['date_registered' => array(
				'header' => array(
					'value' => $txt['date_registered'],
				),
				'data' => array(
					'function' => create_function('$rowData', '
						return timeformat($rowData[\'date_registered\']);
					'),
				),
				'sort' => array(
					'default' => 'date_registered DESC',
					'reverse' => 'date_registered',
				),
			),]]></search>
			<add><![CDATA['join_reason' => array(
				'header' => array(
					'value' => $txt['admin_browse_join_reason'],
				),
				'data' => array(
					'db_htmlsafe' => 'join_reason',
				),
				'sort' =>  array(
					'default' => 'join_reason DESC',
					'reverse' => 'join_reason',
				),
			),]]></add>
		</operation>
		<!-- Thanks to Chas Large for donating this code! -->
		<operation>
			<search position="before"><![CDATA['ip' => array(
				'db_fields' => array('member_ip'),
				'type' => 'string'
			),]]></search>
			<add><![CDATA[			//Join Reason
						'join_reason' => array(
				'db_fields' => array('join_reason'),
				'type' => 'string'
			),
			//end join reason]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA['display_name' => array(
				'header' => array(
					'value' => $txt['display_name'],
				),
				'data' => array(
					'sprintf' => array(
						'format' => '<a href="' . strtr($scripturl, array('%' => '%%')) . '?action=profile;u=%1$d">%2$s</a>',
						'params' => array(
							'id_member' => false,
							'real_name' => false,
						),
					),
				),
				'sort' => array(
					'default' => 'real_name',
					'reverse' => 'real_name DESC',
				),
			),]]></search>
			<add><![CDATA[			//join reason
						'join_reason' => array(
				'header' => array(
					'value' => $txt['join_reason'],
				),
				'data' => array(
					'sprintf' => array(
						'format' => '<a href="' . strtr($scripturl, array('%' => '%%')) . '?action=profile;u=%1$d">%2$s</a>',
						'params' => array(
							'id_member' => false,
							'join_reason' => false,
						),
					),
				),
				'sort' => array(
					'default' => 'location',
					'reverse' => 'location DESC',
				),
			),
		//end join reason]]></add>
		</operation>
		<!-- End Chas Large -->
	</file>

	<file name="$themedir/Register.template.php">
		<operation>
			<search position="before"><![CDATA[<dt><strong><label for="smf_autov_pwverify">', $txt['verify_pass'], ':</label></strong></dt>
						<dd>
							<input type="password" name="passwrd2" id="smf_autov_pwverify" size="30" tabindex="', $context['tabindex']++, '" class="input_password" />
							<span id="smf_autov_pwverify_div" style="display: none;">
								<img id="smf_autov_pwverify_img" src="', $settings['images_url'], '/icons/field_valid.gif" alt="*" />
							</span>
						</dd>]]></search>
			<add><![CDATA[<dt><strong><label for="smf_join_reason">', $txt['join_reason'], ':</label></strong></dt>
						<dd>
							<input type="text" name="join_reason" id="smf_join_reason" size="30" tabindex="', $context['tabindex']++, '" />
						</dd>]]></add>
		</operation>
	</file>

</modification>